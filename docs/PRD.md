# doppelgesicht MVP PRD

## ğŸ¯ í•µì‹¬ ì •ë³´

**ëª©ì **: ê°œì¸ ê¸°ê¸°ì—ì„œ ì‹¤í–‰ë˜ëŠ” ë¡œì»¬ AI ì–´ì‹œìŠ¤í„´íŠ¸ í”Œë«í¼ìœ¼ë¡œ, ê¸°ì¡´ ë©”ì‹ ì €(Telegram, Slack ë“±)ë¥¼ í†µí•´ ì‘ë‹µí•˜ë©° ë°ì´í„° í”„ë¼ì´ë²„ì‹œë¥¼ ë³´ì¥
**ì‚¬ìš©ì**: ê¸°ìˆ ì— ìµìˆ™í•œ ê°œì¸ ì‚¬ìš©ìë¡œ, ìì‹ ì˜ ë°ì´í„°ë¥¼ ë¡œì»¬ì—ì„œ ê´€ë¦¬í•˜ê³  ì‹¶ì–´í•˜ëŠ” ê°œë°œì/ì „ë¬¸ê°€

---

## ğŸš¶ ì‚¬ìš©ì ì—¬ì •

```
1. CLI ì„¤ì¹˜ ë° ì´ˆê¸° ì„¤ì • (onboard)
   â†“ doppelgesicht onboard ì‹¤í–‰

2. ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
   â†“ ìê²© ì¦ëª… ì•”í˜¸í™” ì„¤ì • (Argon2id + AES-256-GCM)

3. LLM í”„ë¡œíŒŒì¼ êµ¬ì„±
   â†“ Anthropic/OpenAI/Moonshot API í‚¤ ì…ë ¥ ë° ì•”í˜¸í™” ì €ì¥

4. ì±„ë„ ì—°ê²° ì„¤ì •
   â†“ Telegram/Slack/Discord ë´‡ í† í° ì…ë ¥

5. Gateway ì‹œì‘
   â†“ doppelgesicht gateway ì‹¤í–‰

6. ë©”ì‹ ì €ì—ì„œ AI ëŒ€í™” ì‹œì‘
   â†“ ì‚¬ìš©ìê°€ Telegram/Slack/Discordì—ì„œ ë©”ì‹œì§€ ì „ì†¡

7. AI ì‘ë‹µ ìˆ˜ì‹ 
   â†“ ë„êµ¬ ì‹¤í–‰ í•„ìš” ì‹œ ìŠ¹ì¸ ìš”ì²­ (CLI ëª¨ë“œ: í„°ë¯¸ë„ UI, Daemon ëª¨ë“œ: ìë™ ê±°ë¶€ ë˜ëŠ” í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸)

8. ëŒ€í™” ì™„ë£Œ ë° ë¡œê·¸ì•„ì›ƒ
```

---

## âš¡ ê¸°ëŠ¥ ëª…ì„¸

### 1. MVP í•µì‹¬ ê¸°ëŠ¥

| ID | ê¸°ëŠ¥ëª… | ì„¤ëª… | MVP í•„ìˆ˜ ì´ìœ  | ê´€ë ¨ í˜ì´ì§€ |
|----|--------|------|-------------|------------|
| **F001** | ë§ˆìŠ¤í„° í‚¤ íŒŒìƒ ë° ì•”í˜¸í™” | Argon2id ê¸°ë°˜ ë§ˆìŠ¤í„° í‚¤ ìƒì„±, AES-256-GCM ìê²© ì¦ëª… ì•”í˜¸í™” | ë°ì´í„° í”„ë¼ì´ë²„ì‹œ í•µì‹¬, í‰ë¬¸ ì €ì¥ ë°©ì§€ | Onboard CLI, ì¸ì¦ í”„ë¡œíŒŒì¼ ê´€ë¦¬ |
| **F002** | LLM í´ë¼ì´ì–¸íŠ¸ í†µí•© | Anthropic Claude, OpenAI GPT, Moonshot Kimi API ì—°ë™ | AI ì‘ë‹µ ìƒì„± í•µì‹¬ ê¸°ëŠ¥ | Gateway ì„œë²„, Agent ëŒ€í™” |
| **F003** | Auth Profile ê´€ë¦¬ | ë‹¤ì¤‘ LLM í”„ë¡œíŒŒì¼ ì €ì¥, fallback ì²´ì¸, rate limiting | ë‹¤ì–‘í•œ ëª¨ë¸ í™œìš© ë° ì•ˆì •ì„± | ì¸ì¦ í”„ë¡œíŒŒì¼ ê´€ë¦¬, Gateway ì„œë²„ |
| **F004** | Telegram ì±„ë„ ì—°ë™ | Telegram Bot APIë¥¼ í†µí•œ ë©”ì‹œì§€ ìˆ˜ì‹ /ë°œì‹  | í•µì‹¬ ë©”ì‹ ì € ì±„ë„ | ì±„ë„ ì„¤ì • |
| **F005** | Slack ì±„ë„ ì—°ë™ | Slack Boltë¥¼ í†µí•œ ë©”ì‹œì§€ ìˆ˜ì‹ /ë°œì‹  | í•µì‹¬ ë©”ì‹ ì € ì±„ë„ | ì±„ë„ ì„¤ì • |
| **F005-1** | Discord ì±„ë„ ì—°ë™ | Discord.jsë¥¼ í†µí•œ ë©”ì‹œì§€ ìˆ˜ì‹ /ë°œì‹  | í•µì‹¬ ë©”ì‹ ì € ì±„ë„ | ì±„ë„ ì„¤ì • |
| **F006** | Bash ë„êµ¬ ì‹¤í–‰ | í„°ë¯¸ë„ ëª…ë ¹ì–´ ì‹¤í–‰, ì¶œë ¥ ìº¡ì²˜ | íŒŒì¼ ì‹œìŠ¤í…œ ì ‘ê·¼ ë° ì‘ì—… ìˆ˜í–‰ | Agent ëŒ€í™” |
| **F007** | ë„êµ¬ ìŠ¹ì¸ ì‹œìŠ¤í…œ | ìœ„í—˜ë„ ê¸°ë°˜ ì‹¤í–‰ ì „ ìŠ¹ì¸ ìš”ì²­ (CLI/Daemon ëª¨ë“œ ì°¨ë³„í™”) | ì•ˆì „í•œ AI ì‘ì—… ìœ„ì„ | ìŠ¹ì¸ UI, Gateway ì„œë²„ |
| **F008** | ë©”ëª¨ë¦¬ ì‹œìŠ¤í…œ | Supabase ê¸°ë°˜ ëŒ€í™” ê¸°ë¡ ì €ì¥, ë¬¸ë§¥ ê´€ë¦¬ | ì—°ì†ì ì¸ ëŒ€í™” ê°€ëŠ¥ | ë°ì´í„° ë ˆì´ì–´ |
| **F009** | Gateway HTTP/WebSocket | REST API ë° ì‹¤ì‹œê°„ ì—°ê²° ì„œë²„ | ì™¸ë¶€ ì±„ë„ ì—°ê²° í—ˆë¸Œ | Gateway ì„œë²„ |
| **F010** | CLI ëª…ë ¹ì–´ | onboard, gateway, agent, config, auth, message, browser ëª…ë ¹ì–´ | ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ | ì „ì²´ CLI |
| **F014** | ë©”ì‹œì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸ | CLIì—ì„œ ì§ì ‘ ì±„ë„ë¡œ ë©”ì‹œì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸ | ì±„ë„ ì—°ê²° ê²€ì¦ | message CLI |

### 2. MVP í•„ìˆ˜ ì§€ì› ê¸°ëŠ¥

| ID | ê¸°ëŠ¥ëª… | ì„¤ëª… | MVP í•„ìˆ˜ ì´ìœ  | ê´€ë ¨ í˜ì´ì§€ |
|----|--------|------|-------------|------------|
| **F011** | ì„¤ì • íŒŒì¼ ê´€ë¦¬ | YAML ê¸°ë°˜ ì„¤ì •, í™˜ê²½ë³€ìˆ˜ ì°¸ì¡°, í•« ë¦¬ë¡œë“œ | ìœ ì—°í•œ êµ¬ì„± ê´€ë¦¬ | ì„¤ì • ê´€ë¦¬ |
| **F012** | ë¡œê¹… ì‹œìŠ¤í…œ | êµ¬ì¡°í™”ëœ JSON ë¡œê¹…, ë””ë²„ê·¸ ëª¨ë“œ | ë¬¸ì œ í•´ê²° ë° ëª¨ë‹ˆí„°ë§ | ì „ì²´ ì‹œìŠ¤í…œ |
| **F013** | Browser ìƒŒë“œë°•ìŠ¤ | isolated-vm ê¸°ë°˜ ì½”ë“œ ê²€ì¦, Playwright ì‹¤í–‰ (2ê³„ì¸µ ê²€ì¦) | ì•ˆì „í•œ ë¸Œë¼ìš°ì € ìë™í™” | browser CLI, Agent ì‹œìŠ¤í…œ |

### 3. MVP ì´í›„ ê¸°ëŠ¥ (ì œì™¸)

- WhatsApp, Signal ë“± ì¶”ê°€ ì±„ë„
- ìŒì„± í†µí™” ê¸°ëŠ¥
- Canvas A2UI ë Œë”ë§
- ìŠ¤í‚¬/í™•ì¥ ì‹œìŠ¤í…œ
- Web UI ëŒ€ì‹œë³´ë“œ
- ëª¨ë°”ì¼ ì•± (iOS/Android)
- ê³ ê¸‰ ë©”ëª¨ë¦¬ (LanceDB ë²¡í„° ê²€ìƒ‰)
- ë°ì´í„° ë³´ì¡´ ì •ì±… ë° PII ë§ˆìŠ¤í‚¹
- SSO ë° ê³ ê¸‰ ì¸ì¦

---

## ğŸ“± ë©”ë‰´ êµ¬ì¡°

```
ğŸ”§ doppelgesicht CLI
â”œâ”€â”€ ğŸš€ onboard - F010
â”‚   â””â”€â”€ ê¸°ëŠ¥: ì´ˆê¸° ì„¤ì • ë§ˆë²•ì‚¬, ë§ˆìŠ¤í„° í‚¤ ì„¤ì • (F001)
â”œâ”€â”€ ğŸŒ gateway - F010
â”‚   â””â”€â”€ ê¸°ëŠ¥: Gateway ì„œë²„ ì‹œì‘ (F009, F002, F003, F007)
â”œâ”€â”€ ğŸ¤– agent - F010
â”‚   â””â”€â”€ ê¸°ëŠ¥: AI ëŒ€í™” ì‹œì‘, ë„êµ¬ ì‹¤í–‰ (F002, F006, F007)
â”œâ”€â”€ ğŸ“¨ message - F014
â”‚   â””â”€â”€ ê¸°ëŠ¥: ë©”ì‹œì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸ (F004, F005, F005-1)
â”œâ”€â”€ âš™ï¸ config - F010
â”‚   â””â”€â”€ ê¸°ëŠ¥: ì„¤ì • ê´€ë¦¬ (F011)
â”œâ”€â”€ ğŸ” auth - F010
â”‚   â””â”€â”€ ê¸°ëŠ¥: ì¸ì¦ í”„ë¡œíŒŒì¼ ê´€ë¦¬ (F001, F003)
â””â”€â”€ ğŸŒ browser - F010
    â””â”€â”€ ê¸°ëŠ¥: ë¸Œë¼ìš°ì € ìë™í™” (F013)

ğŸ“‹ ì„¤ì • íŒŒì¼ êµ¬ì¡° (~/.doppelgesicht/)
â”œâ”€â”€ config.yaml - F011
â”‚   â””â”€â”€ ê¸°ëŠ¥: ì‚¬ìš©ì ì„¤ì •, ì±„ë„ ì„¤ì •, LLM í”„ë¡œíŒŒì¼
â”œâ”€â”€ auth-profiles.json (ì•”í˜¸í™”) - F001
â”‚   â””â”€â”€ ê¸°ëŠ¥: ì•”í˜¸í™”ëœ ìê²© ì¦ëª… ì €ì¥
â””â”€â”€ supabase/ - F008
    â””â”€â”€ ê¸°ëŠ¥: Supabase ì—°ê²° ì„¤ì • ë° ë§ˆì´ê·¸ë ˆì´ì…˜
```

---

## ğŸ“„ í˜ì´ì§€ë³„ ìƒì„¸ ê¸°ëŠ¥

### Onboard CLI (ì´ˆê¸° ì„¤ì •)

> **êµ¬í˜„ ê¸°ëŠ¥:** `F001`, `F010`, `F011` | **ë©”ë‰´ ìœ„ì¹˜:** doppelgesicht onboard

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ì—­í• ** | ì²« ì‹¤í–‰ ì‹œ ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ë° ì´ˆê¸° êµ¬ì„± ìˆ˜í–‰ |
| **ì§„ì… ê²½ë¡œ** | í„°ë¯¸ë„ì—ì„œ `doppelgesicht onboard` ì‹¤í–‰ |
| **ì‚¬ìš©ì í–‰ë™** | â€¢ ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (ìµœì†Œ 12ì, ë³µì¡ë„ ìš”êµ¬)<br>â€¢ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì…ë ¥<br>â€¢ LLM ì œê³µì ì„ íƒ (Anthropic/OpenAI/Moonshot)<br>â€¢ API í‚¤ ì…ë ¥<br>â€¢ Telegram/Slack/Discord ë´‡ í† í° ì…ë ¥ (ì„ íƒ)<br>â€¢ Supabase ì—°ê²° ì„¤ì • (URL, API Key) |
| **ì£¼ìš” ê¸°ëŠ¥** | â€¢ Argon2id ê¸°ë°˜ ë§ˆìŠ¤í„° í‚¤ íŒŒìƒ (64MB memory, 3 iterations, 4 parallelism)<br>â€¢ AES-256-GCM ì•”í˜¸í™” ì„¤ì • (256-bit salt, 12-byte nonce, 16-byte auth tag)<br>â€¢ ì„¤ì • íŒŒì¼ ì´ˆê¸° ìƒì„± (version: "2")<br>â€¢ OS í‚¤ì²´ì¸ í†µí•© ì‹œë„ (macOS/Windows/Linux)<br>â€¢ Supabase í”„ë¡œì íŠ¸ ì—°ê²° ì„¤ì • ë° ì´ˆê¸° í…Œì´ë¸” ìƒì„±<br>â€¢ ê¸°ì¡´ í‰ë¬¸ ìê²© ì¦ëª… ë§ˆì´ê·¸ë ˆì´ì…˜ í”„ë¡¬í”„íŠ¸ (F001-5)<br>â€¢ **[ì™„ë£Œ]** ì„¤ì • ì €ì¥ ë° Gateway ì‹œì‘ ì•ˆë‚´ |
| **ì—ëŸ¬ ì²˜ë¦¬** | ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜ â†’ ì¬ì…ë ¥ ìš”ì²­<br>OS í‚¤ì²´ì¸ ì‹¤íŒ¨ â†’ íŒŒì¼ ê¸°ë°˜ í´ì—ëŸ¬ ë°˜í™˜ ë° ì„œë²„ ì‹œì‘ ì°¨ë‹¨ ì•ˆë‚´<br>API í‚¤ ê²€ì¦ ì‹¤íŒ¨ â†’ ì¬ì…ë ¥ ë˜ëŠ” ìŠ¤í‚µ |
| **ë‹¤ìŒ ì´ë™** | ì„±ê³µ â†’ Gateway ì‹œì‘ ì•ˆë‚´, ì‹¤íŒ¨ â†’ ì˜¤ë¥˜ ë©”ì‹œì§€ ë° ì¬ì‹œë„ |

---

### Gateway ì„œë²„

> **êµ¬í˜„ ê¸°ëŠ¥:** `F002`, `F003`, `F007`, `F008`, `F009`, `F012` | **ë©”ë‰´ ìœ„ì¹˜:** doppelgesicht gateway

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ì—­í• ** | HTTP/WebSocket ì„œë²„ë¡œ ì±„ë„ ì—°ê²° ë° AI ëŒ€í™” ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ |
| **ì§„ì… ê²½ë¡œ** | í„°ë¯¸ë„ì—ì„œ `doppelgesicht gateway` ì‹¤í–‰ ë˜ëŠ” onboard ì™„ë£Œ í›„ ìë™ ì‹œì‘ |
| **ì‚¬ìš©ì í–‰ë™** | â€¢ ì„œë²„ ì‹œì‘ ëŒ€ê¸°<br>â€¢ ë¡œê·¸ ì¶œë ¥ í™•ì¸<br>â€¢ ë©”ì‹ ì €ì—ì„œ ë©”ì‹œì§€ ì „ì†¡<br>â€¢ ë„êµ¬ ìŠ¹ì¸ ìš”ì²­ ì‘ë‹µ (CLI í¬ê·¸ë¼ìš´ë“œ ëª¨ë“œì—ì„œë§Œ) |
| **ì£¼ìš” ê¸°ëŠ¥** | â€¢ HTTP API ì—”ë“œí¬ì¸íŠ¸ ì œê³µ<br>&nbsp;&nbsp;- POST /v1/chat/completions (AI ëŒ€í™”)<br>&nbsp;&nbsp;- GET /v1/models (ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸)<br>&nbsp;&nbsp;- GET /v1/health (í—¬ìŠ¤ ì²´í¬)<br>&nbsp;&nbsp;- POST /v1/channels/send (ë©”ì‹œì§€ ì „ì†¡)<br>&nbsp;&nbsp;- GET /v1/channels (ì±„ë„ ëª©ë¡)<br>â€¢ WebSocket ì‹¤ì‹œê°„ ì—°ê²° ê´€ë¦¬ (ì‹¬ë°•ìˆ˜, ë©”ì‹œì§€ í)<br>â€¢ Auth Profile í•´ê²° ë° fallback ì²˜ë¦¬ (ë¼ìš´ë“œ ë¡œë¹ˆ, ê±´ê°•í•œ í”„ë¡œíŒŒì¼ ìš°ì„ )<br>â€¢ LLM í´ë¼ì´ì–¸íŠ¸ í˜¸ì¶œ (Anthropic/OpenAI/Moonshot ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ)<br>â€¢ ë„êµ¬ ì‹¤í–‰ ê°ì§€ ë° ìŠ¹ì¸ ìš”ì²­ (ìœ„í—˜ë„ í‰ê°€: low/medium/high/critical)<br>â€¢ ë©”ëª¨ë¦¬ ì €ì¥/ê²€ìƒ‰ (Supabase PostgreSQL, ì‹¤ì‹œê°„ êµ¬ë… ì§€ì›)<br>â€¢ **[ì¤‘ì§€]** Ctrl+Cë¡œ ì„œë²„ ì¢…ë£Œ |
| **ì—ëŸ¬ ì²˜ë¦¬** | LLM API ì‹¤íŒ¨ â†’ fallback í”„ë¡œíŒŒì¼ë¡œ ì¬ì‹œë„ (ìµœëŒ€ 3íšŒ)<br>Rate limit ì´ˆê³¼ â†’ exponential backoff (1s, 2s, 4s)<br>ì±„ë„ ì—°ê²° ëŠê¹€ â†’ ìë™ ì¬ì—°ê²° (ìµœëŒ€ 5íšŒ)<br>ë§ˆìŠ¤í„° í‚¤ ë³µí˜¸í™” ì‹¤íŒ¨ â†’ ì„œë²„ ì‹œì‘ ì°¨ë‹¨, onboard ì¬ì‹¤í–‰ ì•ˆë‚´ |
| **ë‹¤ìŒ ì´ë™** | ì‹¤í–‰ ì¤‘ â†’ ë©”ì‹ ì € ëŒ€í™” ëª¨ë“œ, ì¢…ë£Œ â†’ CLIë¡œ ë³µê·€ |

---

### Agent ëŒ€í™” (CLI)

> **êµ¬í˜„ ê¸°ëŠ¥:** `F002`, `F006`, `F007`, `F010` | **ë©”ë‰´ ìœ„ì¹˜:** doppelgesicht agent

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ì—­í• ** | í„°ë¯¸ë„ì—ì„œ ì§ì ‘ AIì™€ ëŒ€í™”í•˜ê³  ë„êµ¬ ì‹¤í–‰ |
| **ì§„ì… ê²½ë¡œ** | í„°ë¯¸ë„ì—ì„œ `doppelgesicht agent` ì‹¤í–‰ |
| **ì‚¬ìš©ì í–‰ë™** | â€¢ ìì—°ì–´ í”„ë¡¬í”„íŠ¸ ì…ë ¥<br>â€¢ ë„êµ¬ ìŠ¹ì¸/ê±°ë¶€ ì‘ë‹µ (í„°ë¯¸ë„ ì¸í„°ë™í‹°ë¸Œ UI)<br>â€¢ ëŒ€í™” ì¢…ë£Œ ëª…ë ¹ ì…ë ¥ |
| **ì£¼ìš” ê¸°ëŠ¥** | â€¢ í”„ë¡¬í”„íŠ¸ ì…ë ¥ ìˆ˜ì‹  (readline ì¸í„°í˜ì´ìŠ¤)<br>â€¢ LLM API í˜¸ì¶œ (ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ, ì²­í¬ ë‹¨ìœ„ ì¶œë ¥)<br>â€¢ ë„êµ¬ í˜¸ì¶œ ê°ì§€ (exec, browser, channel_send)<br>â€¢ ìœ„í—˜ë„ í‰ê°€ ë° ìŠ¹ì¸ UI í‘œì‹œ (@clack/prompts)<br>â€¢ ë„êµ¬ ì‹¤í–‰ ë° ê²°ê³¼ ì „ë‹¬<br>â€¢ **[ì¢…ë£Œ]** exit/quit ëª…ë ¹ìœ¼ë¡œ ì¢…ë£Œ |
| **ì—ëŸ¬ ì²˜ë¦¬** | LLM ì‘ë‹µ ìŠ¤íŠ¸ë¦¼ ì¤‘ë‹¨ â†’ ì¬ì‹œë„ ë²„íŠ¼ ì œê³µ<br>ë„êµ¬ ì‹¤í–‰ ì‹¤íŒ¨ â†’ ì˜¤ë¥˜ ë©”ì‹œì§€ AIì— ì „ë‹¬<br>íƒ€ì„ì•„ì›ƒ (60s) â†’ ìë™ ê±°ë¶€ ì²˜ë¦¬ |
| **ë‹¤ìŒ ì´ë™** | ì¢…ë£Œ â†’ CLIë¡œ ë³µê·€ |

---

### ì±„ë„ ì„¤ì •

> **êµ¬í˜„ ê¸°ëŠ¥:** `F004`, `F005`, `F011` | **ë©”ë‰´ ìœ„ì¹˜:** config.yaml ì±„ë„ ì„¹ì…˜

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ì—­í• ** | Telegram/Slack/Discord ì±„ë„ ì—°ê²° ì„¤ì • ê´€ë¦¬ |
| **ì§„ì… ê²½ë¡œ** | onboard ì¤‘ ë˜ëŠ” `doppelgesicht config`ë¡œ ì„¤ì • íŒŒì¼ í¸ì§‘ |
| **ì‚¬ìš©ì í–‰ë™** | â€¢ ë´‡ í† í° ì…ë ¥<br>â€¢ í—ˆìš© ì‚¬ìš©ì ëª©ë¡ ì„¤ì •<br>â€¢ ì±„ë„ í™œì„±í™”/ë¹„í™œì„±í™” |
| **ì£¼ìš” ê¸°ëŠ¥** | â€¢ Telegram Bot API í† í° ê²€ì¦ (getMe í˜¸ì¶œ)<br>â€¢ Slack App/Bot í† í° ê²€ì¦ (auth.test í˜¸ì¶œ)<br>â€¢ Discord Bot í† í° ê²€ì¦ (gateway ì—°ê²° í…ŒìŠ¤íŠ¸)<br>â€¢ allowed_users í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬<br>â€¢ ì±„ë„ ì–´ëŒ‘í„° ì´ˆê¸°í™”<br>â€¢ **[ì €ì¥]** ì„¤ì • íŒŒì¼ ì €ì¥ ë° Gateway ë¦¬ë¡œë“œ |
| **ì—ëŸ¬ ì²˜ë¦¬** | í† í° ê²€ì¦ ì‹¤íŒ¨ â†’ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ (403: ê¶Œí•œ ì—†ìŒ, 404: í† í° ë¬´íš¨)<br>ì¤‘ë³µ ì±„ë„ ID â†’ ì¶©ëŒ ê²½ê³  |
| **ë‹¤ìŒ ì´ë™** | ì €ì¥ â†’ Gateway ìë™ ë¦¬ë¡œë“œ ë˜ëŠ” ìˆ˜ë™ ì¬ì‹œì‘ ì•ˆë‚´ |

---

### ì¸ì¦ í”„ë¡œíŒŒì¼ ê´€ë¦¬

> **êµ¬í˜„ ê¸°ëŠ¥:** `F001`, `F003` | **ë©”ë‰´ ìœ„ì¹˜:** doppelgesicht auth

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ì—­í• ** | LLM ì œê³µìë³„ API í‚¤ ë° ì¸ì¦ ì •ë³´ ì•”í˜¸í™” ì €ì¥ |
| **ì§„ì… ê²½ë¡œ** | `doppelgesicht auth add`, `doppelgesicht auth list`, `doppelgesicht auth remove` ë“± |
| **ì‚¬ìš©ì í–‰ë™** | â€¢ ì œê³µì ì„ íƒ (anthropic/openai/moonshot)<br>â€¢ ì¸ì¦ ë°©ì‹ ì„ íƒ (oauth/api_key)<br>â€¢ ìê²© ì¦ëª… ì…ë ¥<br>â€¢ í”„ë¡œíŒŒì¼ ëª©ë¡ í™•ì¸ |
| **ì£¼ìš” ê¸°ëŠ¥** | â€¢ AES-256-GCM ì•”í˜¸í™” ì €ì¥ (ë§ˆìŠ¤í„° í‚¤ë¡œ ì•”í˜¸í™”)<br>â€¢ ë§ˆìŠ¤í„° í‚¤ë¡œ ë³µí˜¸í™” (ëŸ°íƒ€ì„ì— ë©”ëª¨ë¦¬ì—ë§Œ ë³´ê´€)<br>â€¢ í”„ë¡œíŒŒì¼ ìš°ì„ ìˆœìœ„/fallback ì„¤ì • (ìˆœì„œ ì§€ì •)<br>â€¢ rate limit ë° health check ì„¤ì • (ê¸°ë³¸ê°’: 60req/min)<br>â€¢ í”„ë¡œíŒŒì¼ ìƒíƒœ ëª¨ë‹ˆí„°ë§ (healthy/degraded/cooldown)<br>â€¢ **[ì¶”ê°€/ì‚­ì œ/ìˆ˜ì •]** í”„ë¡œíŒŒì¼ ê´€ë¦¬ |
| **ì—ëŸ¬ ì²˜ë¦¬** | ë§ˆìŠ¤í„° í‚¤ ì—†ìŒ â†’ onboard ì‹¤í–‰ ì•ˆë‚´<br>ë³µí˜¸í™” ì‹¤íŒ¨ â†’ ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥ ìš”ì²­ (ìµœëŒ€ 3íšŒ)<br>API ê²€ì¦ ì‹¤íŒ¨ â†’ í”„ë¡œíŒŒì¼ ìƒíƒœ degradedë¡œ ì„¤ì • |
| **ë‹¤ìŒ ì´ë™** | ì™„ë£Œ â†’ ì„¤ì • ì €ì¥, í”„ë¡œíŒŒì¼ ì‚¬ìš© ê°€ëŠ¥ |

---

### ìŠ¹ì¸ UI (ë„êµ¬ ì‹¤í–‰ ìŠ¹ì¸)

> **êµ¬í˜„ ê¸°ëŠ¥:** `F007` | **ë©”ë‰´ ìœ„ì¹˜:** Gateway/Agent ì‹¤í–‰ ì¤‘ ìë™ í‘œì‹œ

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ì—­í• ** | ìœ„í—˜í•œ ë„êµ¬ ì‹¤í–‰ ì „ ì‚¬ìš©ì ìŠ¹ì¸ ìš”ì²­ |
| **ì§„ì… ê²½ë¡œ** | AIê°€ exec, file_write ë“± ìœ„í—˜ ë„êµ¬ í˜¸ì¶œ ì‹œ ìë™ í‘œì‹œ |
| **ì‚¬ìš©ì í–‰ë™** | â€¢ ì œì•ˆëœ ì‘ì—… ê²€í† <br>â€¢ ìŠ¹ì¸/ê±°ë¶€/í•­ìƒ í—ˆìš© ì„ íƒ<br>â€¢ íƒ€ì„ì•„ì›ƒ ë‚´ ì‘ë‹µ |
| **ì£¼ìš” ê¸°ëŠ¥** | â€¢ **ìœ„í—˜ë„ ë¶„ë¥˜ ë° í‰ê°€:**<br>&nbsp;&nbsp;- Critical (ë¹¨ê°•): exec, browser, file_write â†’ í•­ìƒ ìŠ¹ì¸ í•„ìš”<br>&nbsp;&nbsp;- High (ì£¼í™©): file_read, web_fetch â†’ ëŒ€ë¶€ë¶„ ìŠ¹ì¸ í•„ìš”<br>&nbsp;&nbsp;- Medium (ë…¸ë‘): web_search â†’ ë¬¸ë§¥ ê¸°ë°˜<br>&nbsp;&nbsp;- Low (ì´ˆë¡): info â†’ ìë™ ìŠ¹ì¸<br>â€¢ ìƒ‰ìƒ ê¸°ë°˜ ìœ„í—˜ í‘œì‹œ<br>â€¢ ì‹¤í–‰ ëª…ë ¹ í‰ë¬¸ í‘œì‹œ (ì˜ˆ: "exec rm -rf /dangerous/path")<br>â€¢ ìŠ¹ì¸ ì„ íƒì§€ ì œê³µ (Yes/No/Always/Always Deny)<br>â€¢ íƒ€ì„ì•„ì›ƒ: ê¸°ë³¸ 60ì´ˆ, ê³ ìœ„í—˜ 120ì´ˆ (íƒ€ì„ì•„ì›ƒ ì‹œ ê¸°ë³¸ê°’: ê±°ë¶€)<br>â€¢ **ì‹¤í–‰ ëª¨ë“œë³„ ë™ì‘:**<br>&nbsp;&nbsp;- **CLI í¬ê·¸ë¼ìš´ë“œ ëª¨ë“œ**: í„°ë¯¸ë„ ì¸í„°ë™í‹°ë¸Œ UI (@clack/prompts)<br>&nbsp;&nbsp;- **Daemon ëª¨ë“œ**: í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê¸°ë°˜ ìë™ ìŠ¹ì¸, ë¯¸ë“±ë¡ ë„êµ¬ëŠ” ìë™ ê±°ë¶€<br>â€¢ **[ì‘ë‹µ]** ìŠ¹ì¸ ì‹œ ì‹¤í–‰, ê±°ë¶€ ì‹œ AIì— ê±°ë¶€ ì•Œë¦¼ |
| **ì—ëŸ¬ ì²˜ë¦¬** | ìŠ¹ì¸ UI í‘œì‹œ ì‹¤íŒ¨ â†’ ìë™ ê±°ë¶€ (ì•ˆì „ ê¸°ë³¸ê°’)<br>ì‚¬ìš©ì ì¸í„°ëŸ½íŠ¸ (Ctrl+C) â†’ ì‹¤í–‰ ì·¨ì†Œ, AIì— ì•Œë¦¼ |
| **ë‹¤ìŒ ì´ë™** | ìŠ¹ì¸ â†’ ë„êµ¬ ì‹¤í–‰ â†’ ê²°ê³¼ AI ì „ë‹¬, ê±°ë¶€ â†’ AIì— ê±°ë¶€ ì•Œë¦¼ |

---

### ì„¤ì • ê´€ë¦¬ (Config CLI)

> **êµ¬í˜„ ê¸°ëŠ¥:** `F011`, `F012` | **ë©”ë‰´ ìœ„ì¹˜:** doppelgesicht config

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ì—­í• ** | ì„¤ì • íŒŒì¼ ì¡°íšŒ, ìˆ˜ì •, ê²€ì¦ |
| **ì§„ì… ê²½ë¡œ** | `doppelgesicht config get`, `doppelgesicht config set`, `doppelgesicht config validate` ë“± |
| **ì‚¬ìš©ì í–‰ë™** | â€¢ ì„¤ì • í‚¤ ì¡°íšŒ<br>â€¢ ì„¤ì • ê°’ ë³€ê²½<br>â€¢ ì„¤ì • íŒŒì¼ ê²€ì¦ |
| **ì£¼ìš” ê¸°ëŠ¥** | â€¢ YAML ì„¤ì • íŒŒì¼ ì½ê¸°/ì“°ê¸°<br>â€¢ í™˜ê²½ë³€ìˆ˜ ì°¸ì¡° í•´ì„ (${VAR} ë¬¸ë²•)<br>â€¢ ì„¤ì • ìŠ¤í‚¤ë§ˆ ê²€ì¦ (Zod ìŠ¤í‚¤ë§ˆ)<br>â€¢ í•« ë¦¬ë¡œë“œ íŠ¸ë¦¬ê±° (íŒŒì¼ ë³€ê²½ ê°ì‹œ)<br>â€¢ **[ì ìš©]** ë³€ê²½ì‚¬í•­ ì €ì¥ ë° ì ìš© |
| **ì—ëŸ¬ ì²˜ë¦¬** | ìŠ¤í‚¤ë§ˆ ê²€ì¦ ì‹¤íŒ¨ â†’ êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ìœ„ì¹˜ í‘œì‹œ<br>í™˜ê²½ë³€ìˆ˜ ë¯¸ì •ì˜ â†’ ê²½ê³  ë©”ì‹œì§€<br>YAML ë¬¸ë²• ì˜¤ë¥˜ â†’ ë¼ì¸ ë²ˆí˜¸ í‘œì‹œ |
| **ë‹¤ìŒ ì´ë™** | ì ìš© â†’ Gateway ë¦¬ë¡œë“œ ë˜ëŠ” ì¬ì‹œì‘ í•„ìš” ì‹œ ì•ˆë‚´ |

---

### Browser ìƒŒë“œë°•ìŠ¤ (browser CLI)

> **êµ¬í˜„ ê¸°ëŠ¥:** `F013` | **ë©”ë‰´ ìœ„ì¹˜:** doppelgesicht browser

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ì—­í• ** | AI ìƒì„± JavaScript ì½”ë“œì˜ ì•ˆì „í•œ ë¸Œë¼ìš°ì € ìë™í™” ì‹¤í–‰ |
| **ì§„ì… ê²½ë¡œ** | `doppelgesicht browser` ë˜ëŠ” Agent ëŒ€í™” ì¤‘ browser ë„êµ¬ í˜¸ì¶œ |
| **ì‚¬ìš©ì í–‰ë™** | â€¢ URL ì…ë ¥ ë˜ëŠ” JavaScript ì½”ë“œ ì œê³µ<br>â€¢ ì‹¤í–‰ ê²°ê³¼ í™•ì¸ |
| **ì£¼ìš” ê¸°ëŠ¥** | â€¢ **2ê³„ì¸µ ê²€ì¦ ì‹œìŠ¤í…œ:**<br>&nbsp;&nbsp;- **Layer 1 (Node.js)**: ì •ì  ë¶„ì„ + isolated-vm ìƒŒë“œë°•ìŠ¤<br>&nbsp;&nbsp;- **Layer 2 (Browser)**: Playwright CDPë¡œ ê²€ì¦ëœ ì½”ë“œ ì‹¤í–‰<br>â€¢ ì •ì  ë¶„ì„ ê·œì¹™ (Tier 1 - Blocking):<br>&nbsp;&nbsp;- eval-usage: `\beval\s*\(` (Critical)<br>&nbsp;&nbsp;- new-function: `new\s+Function\s*\(` (Critical)<br>&nbsp;&nbsp;- child-process: `require\s*\(\s*['"]child_process['"]\s*\)` (Critical)<br>&nbsp;&nbsp;- fs-access: `require\s*\(\s*['"]fs['"]\s*\)` (High)<br>&nbsp;&nbsp;- network-fetch: `fetch\s*\(|axios|request\s*\(` (High)<br>&nbsp;&nbsp;- env-access: `process\.env` (Medium)<br>â€¢ isolated-vm ìƒŒë“œë°•ìŠ¤ ì œì•½:<br>&nbsp;&nbsp;- 30ì´ˆ íƒ€ì„ì•„ì›ƒ<br>&nbsp;&nbsp;- 256MB ë©”ëª¨ë¦¬ ì œí•œ<br>&nbsp;&nbsp;- ì œí•œëœ console, íŒŒì¼/ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼ ë¶ˆê°€<br>â€¢ Playwright ë¸Œë¼ìš°ì € ì»¨í…ìŠ¤íŠ¸ ì‹¤í–‰ (eval() ì—†ìŒ)<br>â€¢ **[ì‹¤í–‰]** ê²€ì¦ëœ ì½”ë“œë§Œ ë¸Œë¼ìš°ì €ë¡œ ì „ì†¡ |
| **ì—ëŸ¬ ì²˜ë¦¬** | ì •ì  ë¶„ì„ ì‹¤íŒ¨ â†’ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ (ì°¨ë‹¨ëœ íŒ¨í„´ ëª…ì‹œ)<br>isolated-vm íƒ€ì„ì•„ì›ƒ â†’ ê°•ì œ ì¢…ë£Œ, ì˜¤ë¥˜ ë°˜í™˜<br>Playwright ì—°ê²° ì‹¤íŒ¨ â†’ ì¬ì‹œë„ (ìµœëŒ€ 3íšŒ) |
| **ë‹¤ìŒ ì´ë™** | ì„±ê³µ â†’ ê²°ê³¼ ë°˜í™˜, ì‹¤íŒ¨ â†’ ì˜¤ë¥˜ ë©”ì‹œì§€ |

---

### ë©”ì‹œì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸ (message CLI)

> **êµ¬í˜„ ê¸°ëŠ¥:** `F014` | **ë©”ë‰´ ìœ„ì¹˜:** doppelgesicht message

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ì—­í• ** | CLIì—ì„œ ì§ì ‘ ì±„ë„ë¡œ ë©”ì‹œì§€ ì „ì†¡í•˜ì—¬ ì—°ê²° í…ŒìŠ¤íŠ¸ |
| **ì§„ì… ê²½ë¡œ** | `doppelgesicht message send --channel <channelId> --text "message"` |
| **ì‚¬ìš©ì í–‰ë™** | â€¢ ì±„ë„ ID ì„ íƒ<br>â€¢ ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ì…ë ¥<br>â€¢ ì „ì†¡ ì‹¤í–‰ |
| **ì£¼ìš” ê¸°ëŠ¥** | â€¢ ì±„ë„ ëª©ë¡ ì¡°íšŒ<br>â€¢ ë©”ì‹œì§€ ì „ì†¡ ì‹¤í–‰<br>â€¢ ì „ì†¡ ê²°ê³¼ í™•ì¸ |
| **ì—ëŸ¬ ì²˜ë¦¬** | ì±„ë„ ë¯¸ì—°ê²° â†’ ì—°ê²° ì„¤ì • ì•ˆë‚´<br>ì „ì†¡ ì‹¤íŒ¨ â†’ ì˜¤ë¥˜ ë©”ì‹œì§€ (ê¶Œí•œ/ë„¤íŠ¸ì›Œí¬) |
| **ë‹¤ìŒ ì´ë™** | ì„±ê³µ â†’ í™•ì¸ ë©”ì‹œì§€, ì‹¤íŒ¨ â†’ ì˜¤ë¥˜ í‘œì‹œ |

---

## ğŸ—„ï¸ ë°ì´í„° ëª¨ë¸

### AuthProfile (ì•”í˜¸í™”ëœ ì¸ì¦ í”„ë¡œíŒŒì¼)

| í•„ë“œ | ì„¤ëª… | íƒ€ì… |
|------|------|------|
| id | í”„ë¡œíŒŒì¼ ê³ ìœ  ì‹ë³„ì | string |
| provider | LLM ì œê³µì (anthropic/openai/moonshot/bedrock/ollama) | string |
| type | ì¸ì¦ ë°©ì‹ (oauth/api_key) | string |
| credentials | AES-256-GCM ì•”í˜¸í™”ëœ ìê²© ì¦ëª… | EncryptedData |
| rateLimits | API í˜¸ì¶œ ì œí•œ ì„¤ì • | { requestsPerMinute: number } |
| health | í”„ë¡œíŒŒì¼ ìƒíƒœ (healthy/degraded/cooldown) | string |
| lastUsed | ë§ˆì§€ë§ˆ ì‚¬ìš© ì‹œê°„ | ISO8601 |
| failCount | ì—°ì† ì‹¤íŒ¨ íšŸìˆ˜ | number |
| priority | fallback ì²´ì¸ ìš°ì„ ìˆœìœ„ | number |

### Session (ëŒ€í™” ì„¸ì…˜)

| í•„ë“œ | ì„¤ëª… | íƒ€ì… |
|------|------|------|
| id | ì„¸ì…˜ ê³ ìœ  ì‹ë³„ì | string |
| channelId | ì±„ë„ ì‹ë³„ì | string |
| userId | ì‚¬ìš©ì ì‹ë³„ì | string |
| messages | ë©”ì‹œì§€ ë°°ì—´ (role, content, timestamp) | Message[] |
| contextWindow | ì»¨í…ìŠ¤íŠ¸ ìœˆë„ìš° ê´€ë¦¬ ì •ë³´ | { tokens: number, compressed: boolean } |
| createdAt | ìƒì„± ì‹œê°„ | ISO8601 |
| updatedAt | ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ | ISO8601 |

### ChannelConfig (ì±„ë„ ì„¤ì •)

| í•„ë“œ | ì„¤ëª… | íƒ€ì… |
|------|------|------|
| id | ì±„ë„ ì‹ë³„ì | string |
| type | ì±„ë„ íƒ€ì… (telegram/slack/discord) | string |
| enabled | í™œì„±í™” ì—¬ë¶€ | boolean |
| credentials | ì±„ë„ë³„ ì¸ì¦ ì •ë³´ (í† í° ë“±, ì•”í˜¸í™”) | EncryptedData |
| allowedUsers | í—ˆìš©ëœ ì‚¬ìš©ì ëª©ë¡ | string[] |
| capabilities | ì±„ë„ ì§€ì› ê¸°ëŠ¥ | { text, images, audio, reactions, threads } |

### ApprovalRequest (ìŠ¹ì¸ ìš”ì²­)

| í•„ë“œ | ì„¤ëª… | íƒ€ì… |
|------|------|------|
| requestId | ìš”ì²­ ê³ ìœ  ì‹ë³„ì | UUID |
| tool | ë„êµ¬ ì´ë¦„ | string |
| params | ë„êµ¬ íŒŒë¼ë¯¸í„° | Record<string, unknown> |
| riskLevel | ìœ„í—˜ ìˆ˜ì¤€ (low/medium/high/critical) | string |
| riskScore | ìœ„í—˜ ì ìˆ˜ (0.0 - 1.0) | number |
| timestamp | ìš”ì²­ ì‹œê°„ | ISO8601 |
| status | ìƒíƒœ (pending/approved/denied) | string |
| mode | ì‹¤í–‰ ëª¨ë“œ (foreground/daemon) | string |

---

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ (ìµœì‹  ë²„ì „)

### ğŸ¨ ì½”ì–´ ëŸ°íƒ€ì„

- **Node.js 22.12.0+** - LTS ëŸ°íƒ€ì„ (>=22.12.0)
- **TypeScript 5.9+** - íƒ€ì… ì‹œìŠ¤í…œ
- **pnpm 10.23.0** - íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €

### ğŸ–¥ï¸ CLI & Gateway

- **Commander.js 14.0.3** - CLI í”„ë ˆì„ì›Œí¬
- **Express 5.2.1** - HTTP ì„œë²„
- **ws 8.19.0** - WebSocket ì„œë²„

### ğŸ¤– LLM í´ë¼ì´ì–¸íŠ¸

- **@anthropic-ai/sdk 0.24.3** - Claude API
- **openai 4.x** - OpenAI API
- **@moonshot-ai/sdk** (ë˜ëŠ” OpenAI í˜¸í™˜ API) - Moonshot Kimi API

### ğŸ’¬ ë©”ì‹ ì € ì±„ë„

- **grammy 1.40.0** - Telegram Bot API
- **@slack/bolt 4.6.0** - Slack í”„ë ˆì„ì›Œí¬
- **@slack/web-api 7.14.0** - Slack Web API
- **discord.js 14.x** - Discord Bot API

### ğŸ—„ï¸ ë°ì´í„° ì €ì¥

- **@supabase/supabase-js 2.x** - Supabase í´ë¼ì´ì–¸íŠ¸ (PostgreSQL + ì‹¤ì‹œê°„)
- **supabase** - í´ë¼ìš°ë“œ PostgreSQL ë°ì´í„°ë² ì´ìŠ¤

### ğŸ”’ ë³´ì•ˆ

- **argon2** - ë§ˆìŠ¤í„° í‚¤ íŒŒìƒ (Argon2id)
  - memoryCost: 65536 (64 MB)
  - timeCost: 3
  - parallelism: 4
  - saltLength: 32
  - hashLength: 32
- **isolated-vm** - JavaScript ìƒŒë“œë°•ìŠ¤
- **playwright-core 1.58.2** - ë¸Œë¼ìš°ì € ìë™í™”

### ğŸ“ ê²€ì¦ & ìœ í‹¸ë¦¬í‹°

- **zod 4.3.6** - ìŠ¤í‚¤ë§ˆ ê²€ì¦
- **@sinclair/typebox 0.34.48** - JSON Schema
- **chalk 5.6.2** - í„°ë¯¸ë„ ìƒ‰ìƒ
- **@clack/prompts 1.0.1** - CLI ì¸í„°ë™í‹°ë¸Œ í”„ë¡¬í”„íŠ¸

### ğŸ§ª ê°œë°œ ë„êµ¬

- **Vitest** - í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬
- **oxlint** - ë¦°íŒ… (type-aware)
- **oxfmt** - ì½”ë“œ í¬ë§·íŒ…
- **tsx** - TypeScript ì‹¤í–‰
- **tsdown/rolldown** - ë²ˆë“¤ë§

---

## âš™ï¸ ë¹„ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­

### ì„±ëŠ¥ ëª©í‘œ

| ì§€í‘œ | ëª©í‘œ | ì¸¡ì • ë°©ë²• |
|------|------|-----------|
| LLM ì‘ë‹µ ì‹œì‘ ì‹œê°„ | < 2ì´ˆ (ì²« ë²ˆì§¸ ì²­í¬) | API í˜¸ì¶œë¶€í„° ì²« ì‘ë‹µê¹Œì§€ |
| ë©”ì‹ ì € ë©”ì‹œì§€ ì²˜ë¦¬ | < 500ms (end-to-end) | ë©”ì‹œì§€ ìˆ˜ì‹ ë¶€í„° ì‘ë‹µ ë°œì†¡ê¹Œì§€ |
| ë„êµ¬ ìŠ¹ì¸ UI í‘œì‹œ | < 100ms | ìš”ì²­ë¶€í„° UI í‘œì‹œê¹Œì§€ |
| Gateway ì‹œì‘ ì‹œê°„ | < 3ì´ˆ | í”„ë¡œì„¸ìŠ¤ ì‹œì‘ë¶€í„° API ì‚¬ìš© ê°€ëŠ¥ê¹Œì§€ |
| ì•”í˜¸í™” ì˜¤ë²„í—¤ë“œ | < 50ms | í”„ë¡œíŒŒì¼ ë³µí˜¸í™” ì‹œê°„ |
| ìƒŒë“œë°•ìŠ¤ ì‹œì‘ ì‹œê°„ | < 500ms | isolated-vm ì´ˆê¸°í™” ì‹œê°„ |

### ì—ëŸ¬ ì²˜ë¦¬ ë° ë³µêµ¬ ì „ëµ

| ì‹œë‚˜ë¦¬ì˜¤ | ì²˜ë¦¬ ë°©ì•ˆ | ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜ |
|----------|-----------|---------------|
| **LLM API ì¥ì• ** | fallback í”„ë¡œíŒŒì¼ë¡œ ìë™ ì „í™˜ | ìµœëŒ€ 3íšŒ ì¬ì‹œë„, exponential backoff (1s, 2s, 4s) |
| **Rate limit ì´ˆê³¼** | ìš”ì²­ íì‰ ë° ì§€ì—° ì²˜ë¦¬ | í—¤ë”ì˜ Retry-After ëŒ€ê¸°, ìë™ ì¬ì‹œë„ |
| **ì±„ë„ ì—°ê²° ëŠê¹€** | ìë™ ì¬ì—°ê²° ì‹œë„ | ìµœëŒ€ 5íšŒ ì¬ì—°ê²°, 1ì´ˆ ê°„ê²© |
| **ë§ˆìŠ¤í„° í‚¤ ë¶„ì‹¤** | ë³µêµ¬ ë¶ˆê°€, ì¬ì„¤ì • í•„ìš” | ë°ì´í„° ì´ˆê¸°í™” ë° onboard ì¬ì‹¤í–‰ ì•ˆë‚´ |
| **Supabase ì—°ê²° ì‹¤íŒ¨** | ì—ëŸ¬ ë°˜í™˜ ë° ì„œë²„ ì‹œì‘ ì°¨ë‹¨ | ì—°ê²° ì„¤ì • í™•ì¸ ì•ˆë‚´, ì˜¬ë°”ë¥¸ URL/API Key ìš”êµ¬ |
| **ë©”ëª¨ë¦¬ ì œí•œ ì´ˆê³¼** | í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ | graceful shutdown ë° ìƒíƒœ ë³µêµ¬ |

### ë™ì‹œì„± ì œì–´

```typescript
// Supabase ì—°ê²° í’€ ì„¤ì •
interface SupabaseConfig {
  url: string;
  anonKey: string;
  options: {
    auth: {
      persistSession: true;
    };
    db: {
      schema: "public";
    };
  };
}

// ì‹¤ì‹œê°„ êµ¬ë… ì„¤ì •
interface RealtimeConfig {
  enabled: true;
  tables: ["sessions", "messages"];
}

// ì„¸ì…˜ ê²©ë¦¬
interface SessionIsolation {
  perUser: true;     // ì‚¬ìš©ìë³„ ì„¸ì…˜ ë¶„ë¦¬
  perChannel: true;  // ì±„ë„ë³„ ì„¸ì…˜ ë¶„ë¦¬
  rowLevelSecurity: true;  // Supabase RLS í™œì„±í™”
}
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì „ëµ

### í…ŒìŠ¤íŠ¸ ë²”ìœ„

| í…ŒìŠ¤íŠ¸ ìœ í˜• | ì»¤ë²„ë¦¬ì§€ ëª©í‘œ | ì£¼ìš” ì‹œë‚˜ë¦¬ì˜¤ |
|-------------|---------------|---------------|
| **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸** | 70%+ | ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜, ì•”í˜¸í™”/ë³µí˜¸í™”, ìŠ¤í‚¤ë§ˆ ê²€ì¦ |
| **í†µí•© í…ŒìŠ¤íŠ¸** | í•µì‹¬ ê²½ë¡œ | Gateway API, ì±„ë„ ì–´ëŒ‘í„°, LLM í´ë¼ì´ì–¸íŠ¸ |
| **E2E í…ŒìŠ¤íŠ¸** | ì£¼ìš” ì‚¬ìš©ì ì—¬ì • | onboard â†’ gateway â†’ ë©”ì‹ ì € ëŒ€í™” íë¦„ |
| **ë³´ì•ˆ í…ŒìŠ¤íŠ¸** | Critical ê²½ë¡œ | ì•”í˜¸í™” ê²€ì¦, ìƒŒë“œë°•ìŠ¤ ìš°íšŒ ì‹œë„, ìŠ¹ì¸ ì‹œìŠ¤í…œ |

### E2E í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

1. **ì •ìƒ í”Œë¡œìš°**: onboard â†’ gateway ì‹œì‘ â†’ Telegram/Slack/Discord ë©”ì‹œì§€ â†’ AI ì‘ë‹µ
2. **fallback ì‹œë‚˜ë¦¬ì˜¤**: Primary LLM(Anthropic) ì‹¤íŒ¨ â†’ Secondary LLM(OpenAI/Moonshot) ì „í™˜ â†’ ì‘ë‹µ ì™„ë£Œ
3. **ìŠ¹ì¸ í”Œë¡œìš°**: ìœ„í—˜ ë„êµ¬ í˜¸ì¶œ â†’ ìŠ¹ì¸ UI í‘œì‹œ â†’ ì‚¬ìš©ì ìŠ¹ì¸ â†’ ì‹¤í–‰ â†’ ê²°ê³¼ ë°˜í™˜
4. **ì˜¤ë¥˜ ë³µêµ¬**: ì±„ë„ ì—°ê²° ëŠê¹€ â†’ ìë™ ì¬ì—°ê²° â†’ ë©”ì‹œì§€ ì²˜ë¦¬ ì¬ê°œ
5. **ë©€í‹° ì±„ë„**: Telegram ë©”ì‹œì§€ â†’ Supabase ì €ì¥ â†’ Discordì—ì„œ ë™ì¼ ì„¸ì…˜ ì¡°íšŒ

---

## ğŸ”’ ë³´ì•ˆ ìƒì„¸

### ë§ˆìŠ¤í„° í‚¤ íŒŒìƒ (Argon2id)

```typescript
const argon2Params = {
  type: "argon2id",
  memoryCost: 65536,    // 64 MB
  timeCost: 3,          // 3 iterations
  parallelism: 4,       // 4 threads
  saltLength: 32,       // 256-bit salt
  hashLength: 32        // 256-bit output
};
```

### ì•”í˜¸í™” ë°ì´í„° êµ¬ì¡°

```typescript
interface EncryptedAuthProfile {
  version: 2;
  metadata: {
    createdAt: ISO8601;
    updatedAt: ISO8601;
    keyId: string;
  };
  encryption: {
    algorithm: "AES-256-GCM";
    salt: Base64;           // 32 bytes
    nonce: Base64;          // 12 bytes (GCM)
    tag: Base64;            // 16 bytes auth tag
  };
  ciphertext: Base64;
}
```

### Gateway ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ

| ê¸°ëŠ¥ | ì„¤ì • | ê¸°ë³¸ê°’ |
|------|------|--------|
| ë°”ì¸ë”© ì£¼ì†Œ | `host` | `127.0.0.1` (localhostë§Œ) |
| ì¸í„°í˜ì´ìŠ¤ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ | `allowedInterfaces` | `[]` (ëª…ì‹œì  ì„¤ì • í•„ìš”) |
| CIDR ê¸°ë°˜ ACL | `cidrAllowList` | `["127.0.0.1/32"]` |
| JWT ì„¸ì…˜ | `auth.jwt.enabled` | `true` |

---

## ğŸ“‹ doppelgesicht.md ê¸°ë°˜ ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

| ì›ë³¸ ì„¹ì…˜ | PRD ë°˜ì˜ ì—¬ë¶€ | ìœ„ì¹˜ |
|-----------|---------------|------|
| 1. í”„ë¡œì íŠ¸ ê°œìš” | âœ… | í•µì‹¬ ì •ë³´ |
| 2. ì•„í‚¤í…ì²˜ ê°œìš” | âœ… | ê¸°ëŠ¥ ëª…ì„¸, ë°ì´í„° íë¦„ |
| 3. ë””ë ‰í† ë¦¬ êµ¬ì¡° | âœ… | ê¸°ìˆ  ìŠ¤íƒ ì°¸ê³  |
| 4.1 CLI ì‹œìŠ¤í…œ | âœ… | í˜ì´ì§€ë³„ ìƒì„¸ ê¸°ëŠ¥ - ê° CLI ëª…ë ¹ì–´ |
| 4.2 Gateway ì‹œìŠ¤í…œ | âœ… | Gateway ì„œë²„ í˜ì´ì§€ |
| 4.3 Agent ì‹œìŠ¤í…œ | âœ… | Agent ëŒ€í™” í˜ì´ì§€, Auth Profile ê´€ë¦¬ |
| 4.4 ì±„ë„ ì‹œìŠ¤í…œ | âœ… | ì±„ë„ ì„¤ì • í˜ì´ì§€ |
| 5. ê¸°ìˆ  ìŠ¤íƒ | âœ… | ê¸°ìˆ  ìŠ¤íƒ ì„¹ì…˜ |
| 6. ë°ì´í„° íë¦„ | âœ… | ì‚¬ìš©ì ì—¬ì •, í˜ì´ì§€ë³„ ê¸°ëŠ¥ |
| 7.1 ë‹¤ì¤‘ LLM ì§€ì› | âœ… | F002, F003 |
| 7.2 ì±„ë„ ê¸°ëŠ¥ í–‰ë ¬ | âœ… | F004, F005, ChannelConfig ëª¨ë¸ |
| 7.3 ìŠ¤í‚¬ ì‹œìŠ¤í…œ | âŒ (MVP ì´í›„) | MVP ì´í›„ ê¸°ëŠ¥ìœ¼ë¡œ ë¶„ë¥˜ |
| 14. ë³´ì•ˆ ê°œì„ ì‚¬í•­ | âœ… | F001, F007, F013, ë³´ì•ˆ ìƒì„¸ ì„¹ì…˜ |
| 14.1 ë³´ì•ˆ ì·¨ì•½ì  ê°œìš” | âœ… | F001, F007, F013 |
| 14.2 ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ (F001-F008) | âœ… | F001(ì•”í˜¸í™”), F007(ìŠ¹ì¸), F013(ìƒŒë“œë°•ìŠ¤) ë°˜ì˜ |
| 14.3 ë°ì´í„° ëª¨ë¸ | âœ… | ë°ì´í„° ëª¨ë¸ ì„¹ì…˜ |
| 14.5 ì„±ê³µ ê¸°ì¤€ | âœ… | ì„±ëŠ¥ ëª©í‘œ, í…ŒìŠ¤íŠ¸ ì „ëµ |
| 14.6 ì‚¬ìš©ì ìŠ¤í† ë¦¬ | âœ… | ì‚¬ìš©ì ì—¬ì • ì°¸ê³  |
| 14.8 ìœ„í˜‘ ëª¨ë¸ | âœ… | ë³´ì•ˆ ìƒì„¸ ì„¹ì…˜ ì°¸ê³  |

**ëˆ„ë½ëœ í•­ëª©**: ì—†ìŒ (ëª¨ë“  í•µì‹¬ ë‚´ìš©ì´ MVP ë˜ëŠ” MVP ì´í›„ ê¸°ëŠ¥ìœ¼ë¡œ ë¶„ë¥˜ë¨)

---

## ğŸ› ï¸ ë„êµ¬ í†µí•© ì‹œìŠ¤í…œ (Tool Integration)

### ê°œìš”

AI ì–´ì‹œìŠ¤í„´íŠ¸ê°€ ì‹¤ì‹œê°„ ë°ì´í„°ì— ì ‘ê·¼í•˜ê³  ì™¸ë¶€ ì‹œìŠ¤í…œê³¼ ìƒí˜¸ì‘ìš©í•˜ê¸° ìœ„í•œ ë„êµ¬ ì‹œìŠ¤í…œ. LLMì´ ìì—°ì–´ ìš”ì²­ì„ ë¶„ì„í•˜ì—¬ ì ì ˆí•œ ë„êµ¬ë¥¼ í˜¸ì¶œí•˜ê³ , ì‹¤í–‰ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìµœì¢… ì‘ë‹µì„ ìƒì„±í•˜ëŠ” êµ¬ì¡°.

### ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Tool Integration Flow                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. ì‚¬ìš©ì ë©”ì‹œì§€ ìˆ˜ì‹                                         â”‚
â”‚     â†“                                                        â”‚
â”‚  2. LLMì— ë„êµ¬ ëª©ë¡ ì „ë‹¬ + ì‚¬ìš©ì ë©”ì‹œì§€                      â”‚
â”‚     â†“                                                        â”‚
â”‚  3. LLMì´ ë„êµ¬ í˜¸ì¶œ ê²°ì • (tool_use)                          â”‚
â”‚     â†“                                                        â”‚
â”‚  4. ë„êµ¬ ì‹¤í–‰ (ìŠ¹ì¸ í•„ìš” ì‹œ UI í‘œì‹œ)                         â”‚
â”‚     â†“                                                        â”‚
â”‚  5. ì‹¤í–‰ ê²°ê³¼ë¥¼ LLMì— ì „ë‹¬ (tool_result)                     â”‚
â”‚     â†“                                                        â”‚
â”‚  6. LLMì´ ìµœì¢… ì‘ë‹µ ìƒì„±                                     â”‚
â”‚     â†“                                                        â”‚
â”‚  7. ì‚¬ìš©ìì—ê²Œ ì‘ë‹µ ì „ì†¡                                     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì§€ì› ë„êµ¬ ëª©ë¡

| ID | ë„êµ¬ëª… | ì„¤ëª… | ìœ„í—˜ë„ | ìŠ¹ì¸ í•„ìš” | ì‚¬ìš© ì˜ˆì‹œ | êµ¬í˜„ ìƒíƒœ |
|----|--------|------|--------|-----------|-----------|-----------|
| **T001** | exec | í„°ë¯¸ë„ ëª…ë ¹ì–´ ì‹¤í–‰ | Critical | ì˜ˆ | `curl`ë¡œ API í˜¸ì¶œ, íŒŒì¼ ì¡°ì‘ | âœ… ì™„ë£Œ |
| **T002** | web_fetch | URLë¡œ HTTP ìš”ì²­ | High | ì˜ˆ | ì›¹ í˜ì´ì§€ ì½˜í…ì¸  ê°€ì ¸ì˜¤ê¸° | âš ï¸ ë¶€ë¶„ êµ¬í˜„ (GETë§Œ ì§€ì›, POST/PUT/DELETEëŠ” í–¥í›„ ì§€ì› ì˜ˆì •) |
| **T003** | browser | Playwright ë¸Œë¼ìš°ì € ìë™í™” | Critical | ì˜ˆ | ë™ì  ì›¹ì‚¬ì´íŠ¸ ìŠ¤í¬ë˜í•‘ | âŒ ë¯¸êµ¬í˜„ |
| **T004** | file_read | íŒŒì¼ ì½ê¸° | High | ì˜ˆ | ë¡œì»¬ íŒŒì¼ ë‚´ìš© í™•ì¸ | âœ… ì™„ë£Œ |
| **T005** | file_write | íŒŒì¼ ì“°ê¸° | Critical | ì˜ˆ | ì„¤ì • íŒŒì¼ ìˆ˜ì • | âœ… ì™„ë£Œ |
| **T006** | channel_send | ë©”ì‹ ì €ë¡œ ë©”ì‹œì§€ ì „ì†¡ | Medium | ì˜ˆ | ë‹¤ë¥¸ ì±„ë„ë¡œ ì•Œë¦¼ ì „ì†¡ | âŒ ë¯¸êµ¬í˜„ |

**ì°¸ê³ **: PRDì™€ ì½”ë“œ ê°„ ë„êµ¬ëª… í†µì¼ì„ ìœ„í•´ `bash`ë¥¼ `exec`ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤. ì½”ë“œë² ì´ìŠ¤ì—ì„œëŠ” `exec`ë¡œ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

### ë„êµ¬ ì •ì˜ ìŠ¤í‚¤ë§ˆ

```typescript
interface ToolDefinition {
  type: 'function';
  function: {
    name: string;           // ë„êµ¬ ì‹ë³„ì (ì˜ˆ: "exec")
    description: string;    // ë„êµ¬ ì„¤ëª… ë° ì‚¬ìš© ì‹œê¸°
    parameters: {
      type: 'object';
      properties: {
        [paramName: string]: {
          type: string;     // string, number, boolean, array, object
          description: string;
          enum?: string[];  // ì„ íƒì  ê°’ ëª©ë¡
        };
      };
      required: string[];   // í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëª©ë¡
    };
  };
}
```

### ë„êµ¬ ì •ì˜ ì˜ˆì‹œ

#### exec (T001)

```typescript
{
  type: 'function',
  function: {
    name: 'exec',
    description: `Execute shell commands. Use for:
- Running scripts
- File operations (ls, cat, grep)
- Network requests (curl, wget)
- System information (date, uname)`,
    parameters: {
      type: 'object',
      properties: {
        command: {
          type: 'string',
          description: 'The shell command to execute'
        },
        timeout: {
          type: 'number',
          description: 'Timeout in milliseconds (default: 30000)'
        },
        cwd: {
          type: 'string',
          description: 'Working directory for command execution'
        }
      },
      required: ['command']
    }
  }
}
```

**ì‹¤í–‰ ê²°ê³¼ ìŠ¤í‚¤ë§ˆ:**
```typescript
interface ExecToolResult {
  command: string;      // ì‹¤í–‰ëœ ëª…ë ¹ì–´
  stdout: string;       // í‘œì¤€ ì¶œë ¥
  stderr: string;       // í‘œì¤€ ì—ëŸ¬
  exitCode: number;     // ì¢…ë£Œ ì½”ë“œ (0=ì„±ê³µ)
  duration: number;     // ì‹¤í–‰ ì‹œê°„ (ms)
  timedOut: boolean;    // íƒ€ì„ì•„ì›ƒ ì—¬ë¶€
  finishedAt: Date;     // ì¢…ë£Œ ì‹œê°„
}
```

#### web_fetch (T002)

> **ì°¸ê³ **: í˜„ì¬ GET ë©”ì„œë“œë§Œ ì§€ì›ë˜ë©°, POST/PUT/DELETEëŠ” í–¥í›„ ì§€ì› ì˜ˆì •ì…ë‹ˆë‹¤.

```typescript
{
  type: 'function',
  function: {
    name: 'web_fetch',
    description: `Fetch content from a URL. Use for:
- Retrieving web page HTML
- API calls (REST, GraphQL)
- Downloading data`,
    parameters: {
      type: 'object',
      properties: {
        url: {
          type: 'string',
          description: 'URL to fetch'
        },
        method: {
          type: 'string',
          enum: ['GET', 'POST', 'PUT', 'DELETE'],
          description: 'HTTP method'
        },
        headers: {
          type: 'object',
          description: 'HTTP headers'
        },
        body: {
          type: 'string',
          description: 'Request body (for POST/PUT)'
        }
      },
      required: ['url']
    }
  }
}
```

**ì‹¤í–‰ ê²°ê³¼ ìŠ¤í‚¤ë§ˆ:**
```typescript
interface WebFetchToolResult {
  status: number;       // HTTP ìƒíƒœ ì½”ë“œ
  headers: Record<string, string>;  // ì‘ë‹µ í—¤ë”
  body: string;         // ì‘ë‹µ ë³¸ë¬¸
  duration: number;     // ì‹¤í–‰ ì‹œê°„ (ms)
  url: string;          // ìµœì¢… URL (ë¦¬ë‹¤ì´ë ‰íŠ¸ í›„)
}
```

### ë„êµ¬ ì‹¤í–‰ íë¦„ (Tool Call Loop)

**í•µì‹¬ ê°œë…**: Tool Call LoopëŠ” LLMì´ ë„êµ¬ë¥¼ ë°˜ë³µì ìœ¼ë¡œ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤. í•œ ë²ˆì˜ ë„êµ¬ ì‹¤í–‰ ê²°ê³¼ë¥¼ ë°›ì•„ ë‹¤ì‹œ LLMì— ì „ë‹¬í•˜ë©´, LLMì€ ì¶”ê°€ ë„êµ¬ í˜¸ì¶œì´ í•„ìš”í•œì§€ íŒë‹¨í•©ë‹ˆë‹¤. ì´ ê³¼ì •ì´ ë°˜ë³µë˜ì–´ ìµœì¢… ì‘ë‹µì´ ìƒì„±ë©ë‹ˆë‹¤.

```typescript
async function executeWithTools(
  client: ILLMClient,
  messages: ChatMessage[],
  tools: ToolDefinition[]
): Promise<string> {
  const maxIterations = 10;  // ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜ ì œí•œ
  let iterations = 0;
  const startTime = Date.now();
  const maxTotalDuration = 5 * 60 * 1000;  // ì´ ì‹¤í–‰ ì‹œê°„ ì œí•œ: 5ë¶„

  // ë°˜ë³µ í˜¸ì¶œ ë£¨í”„ (while loop)
  while (iterations < maxIterations) {
    iterations++;

    // ì´ ì‹¤í–‰ ì‹œê°„ ì²´í¬
    if (Date.now() - startTime > maxTotalDuration) {
      throw new Error('Total execution time exceeded 5 minutes');
    }

    // 1. LLM í˜¸ì¶œ (ë„êµ¬ ëª©ë¡ ì „ë‹¬)
    const response = await client.complete({
      model: 'moonshot-v1-8k',
      messages,
      tools,
      max_tokens: 4096
    });

    const message = response.message;

    // 2. ë„êµ¬ í˜¸ì¶œì´ ì—†ìœ¼ë©´ ìµœì¢… ì‘ë‹µ ë°˜í™˜
    if (!message.tool_calls || message.tool_calls.length === 0) {
      return message.content;
    }

    // 3. Assistant ë©”ì‹œì§€ ì¶”ê°€ (ë„êµ¬ í˜¸ì¶œ ì •ë³´ í¬í•¨)
    messages.push(message);

    // 4. ê° ë„êµ¬ í˜¸ì¶œ ì²˜ë¦¬
    for (const toolCall of message.tool_calls) {
      // 4a. ìŠ¹ì¸ í™•ì¸ (ìœ„í—˜ë„ì— ë”°ë¼)
      const approved = await requestApproval(toolCall);

      if (!approved) {
        messages.push({
          role: 'tool',
          tool_call_id: toolCall.id,
          content: 'Tool execution was denied by user'
        });
        continue;
      }

      // 4b. ë„êµ¬ ì‹¤í–‰
      const result = await executeTool(toolCall);

      // 4c. ë„êµ¬ ê²°ê³¼ë¥¼ ë©”ì‹œì§€ì— ì¶”ê°€ (LLMì´ ë‹¤ìŒ íŒë‹¨ì— ì‚¬ìš©)
      messages.push({
        role: 'tool',
        tool_call_id: toolCall.id,
        content: JSON.stringify(result)
      });
    }

    // 5. while ë£¨í”„ ë°˜ë³µ: ë„êµ¬ ê²°ê³¼ë¥¼ ë°›ì•„ ë‹¤ì‹œ LLM í˜¸ì¶œ
    // LLMì´ ì¶”ê°€ ë„êµ¬ í˜¸ì¶œì´ í•„ìš”í•œì§€ ë˜ëŠ” ìµœì¢… ì‘ë‹µì„ ìƒì„±í• ì§€ ê²°ì •
  }

  throw new Error('Maximum tool call iterations exceeded');
}
```

**ë°˜ë³µ í˜¸ì¶œ íë¦„ ë‹¤ì´ì–´ê·¸ë¨:**

```
ì‚¬ìš©ì ì…ë ¥
    â†“
[while ë£¨í”„ ì‹œì‘]
    â†“
LLM í˜¸ì¶œ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                           â”‚
ë„êµ¬ í˜¸ì¶œ í•„ìš”? â”€â”€ì•„ë‹ˆì˜¤â”€â”€â†’ ìµœì¢… ì‘ë‹µ ë°˜í™˜
    â”‚ (ì˜ˆ)                      â”‚
    â†“                           â”‚
ìŠ¹ì¸ í™•ì¸                        â”‚
    â†“                           â”‚
ë„êµ¬ ì‹¤í–‰                        â”‚
    â†“                           â”‚
ê²°ê³¼ë¥¼ messagesì— ì¶”ê°€            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë©”ì‹œì§€ íë¦„ ì˜ˆì‹œ

**ì‚¬ìš©ì**: "ê°•ë™êµ¬ ë‚ ì”¨ ì•Œë ¤ì¤˜"

```typescript
// 1. ì´ˆê¸° ë©”ì‹œì§€
messages = [
  { role: 'user', content: 'ê°•ë™êµ¬ ë‚ ì”¨ ì•Œë ¤ì¤˜' }
];

// 2. LLM ì²« ì‘ë‹µ - ë„êµ¬ í˜¸ì¶œ
tool_calls: [
  {
    id: 'call_123',
    type: 'function',
    function: {
      name: 'web_fetch',
      arguments: JSON.stringify({
        url: 'https://api.openweathermap.org/data/2.5/weather?q=Gangdong-gu,Seoul&appid=...',
        method: 'GET'
      })
    }
  }
];

// 3. messages ì—…ë°ì´íŠ¸
messages = [
  { role: 'user', content: 'ê°•ë™êµ¬ ë‚ ì”¨ ì•Œë ¤ì¤˜' },
  { role: 'assistant', content: '', tool_calls: [...] },
  {
    role: 'tool',
    tool_call_id: 'call_123',
    content: JSON.stringify({
      temp: 15,
      weather: 'Clear',
      humidity: 45
    })
  }
];

// 4. LLM ìµœì¢… ì‘ë‹µ
finalResponse: 'í˜„ì¬ ê°•ë™êµ¬ëŠ” ë§‘ê³  ê¸°ì˜¨ì€ 15ë„, ìŠµë„ëŠ” 45%ì…ë‹ˆë‹¤.';
```

### ë„êµ¬ ì‹¤í–‰ ì œí•œ

| ì œí•œ í•­ëª© | ê°’ | ì„¤ëª… | êµ¬í˜„ ìƒíƒœ |
|-----------|-----|------|-----------|
| ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜ | 10íšŒ | ë¬´í•œ ë£¨í”„ ë°©ì§€ | âœ… êµ¬í˜„ë¨ |
| ë‹¨ì¼ ë„êµ¬ íƒ€ì„ì•„ì›ƒ | 30ì´ˆ | exec, web_fetch | âœ… êµ¬í˜„ë¨ |
| ë¸Œë¼ìš°ì € íƒ€ì„ì•„ì›ƒ | 60ì´ˆ | browser ë„êµ¬ | âœ… êµ¬í˜„ë¨ |
| ì´ ì‹¤í–‰ ì‹œê°„ ì œí•œ | 5ë¶„ | ì „ì²´ íë¦„ ì œí•œ | âœ… êµ¬í˜„ë¨ |
| ì¶œë ¥ í¬ê¸° ì œí•œ | 1MB | ê³¼ë„í•œ ë°ì´í„° ë°©ì§€ | âœ… êµ¬í˜„ë¨ (ëª¨ë“  ë„êµ¬ì— ì ìš©) |

**êµ¬í˜„ í•„ìš” ì‚¬í•­:**
- `maxIterations` ì¹´ìš´í„°ë¥¼ í†µí•œ ë°˜ë³µ íšŸìˆ˜ ì œí•œ
- `startTime` ê¸°ë°˜ ì´ ì‹¤í–‰ ì‹œê°„ ì²´í¬
- ëª¨ë“  ë„êµ¬ì— ëŒ€í•œ ì¶œë ¥ í¬ê¸° ì œí•œ ì ìš©

### ì—ëŸ¬ ì²˜ë¦¬

| ì‹œë‚˜ë¦¬ì˜¤ | ì²˜ë¦¬ ë°©ì•ˆ | LLM ì „ë‹¬ ë‚´ìš© |
|----------|-----------|---------------|
| ë„êµ¬ ì‹¤í–‰ ì‹¤íŒ¨ | ì—ëŸ¬ ë©”ì‹œì§€ ì „ë‹¬ | `error: "Command failed: ..."` |
| íƒ€ì„ì•„ì›ƒ | íƒ€ì„ì•„ì›ƒ ì•Œë¦¼ | `error: "Tool execution timed out"` |
| ìŠ¹ì¸ ê±°ë¶€ | ê±°ë¶€ ì‚¬ìœ  ì „ë‹¬ | `error: "User denied tool execution"` |
| ì¶œë ¥ ì´ˆê³¼ | truncated í‘œì‹œ | `output: "...(truncated)"` |


### ë„êµ¬ ì‹¤í–‰ ê²°ê³¼ ìŠ¤í‚¤ë§ˆ

ê° ë„êµ¬ë³„ ì‹¤í–‰ ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ìŠ¤í‚¤ë§ˆë¥¼ ë”°ë¦…ë‹ˆë‹¤:

#### exec ê²°ê³¼
```typescript
interface ExecToolResult {
  command: string;      // ì‹¤í–‰ëœ ëª…ë ¹ì–´
  stdout: string;       // í‘œì¤€ ì¶œë ¥
  stderr: string;       // í‘œì¤€ ì—ëŸ¬
  exitCode: number;     // ì¢…ë£Œ ì½”ë“œ (0=ì„±ê³µ)
  duration: number;     // ì‹¤í–‰ ì‹œê°„ (ms)
  timedOut: boolean;    // íƒ€ì„ì•„ì›ƒ ì—¬ë¶€
  finishedAt: Date;     // ì¢…ë£Œ ì‹œê°„
}
```

#### web_fetch ê²°ê³¼
```typescript
interface WebFetchToolResult {
  status: number;                   // HTTP ìƒíƒœ ì½”ë“œ
  headers: Record<string, string>;  // ì‘ë‹µ í—¤ë”
  body: string;                     // ì‘ë‹µ ë³¸ë¬¸
  duration: number;                 // ì‹¤í–‰ ì‹œê°„ (ms)
  url: string;                      // ìµœì¢… URL (ë¦¬ë‹¤ì´ë ‰íŠ¸ í›„)
}
```

#### browser ê²°ê³¼
```typescript
interface BrowserToolResult {
  success: boolean;                 // ì‹¤í–‰ ì„±ê³µ ì—¬ë¶€
  url?: string;                     // í˜ì´ì§€ URL
  title?: string;                   // í˜ì´ì§€ ì œëª©
  consoleLogs: BrowserConsoleLog[]; // ì½˜ì†” ë¡œê·¸
  screenshot?: string;              // ìŠ¤í¬ë¦°ìƒ· (base64)
  duration: number;                 // ì‹¤í–‰ ì‹œê°„ (ms)
}

interface BrowserConsoleLog {
  type: 'log' | 'error' | 'warn' | 'info' | 'debug';
  message: string;
  timestamp: Date;
}
```

#### file_read ê²°ê³¼
```typescript
interface FileReadToolResult {
  content: string;      // íŒŒì¼ ë‚´ìš©
  size: number;         // íŒŒì¼ í¬ê¸° (bytes)
  encoding: string;     // ì¸ì½”ë”© (utf-8 ë“±)
  path: string;         // íŒŒì¼ ê²½ë¡œ
}
```

#### file_write ê²°ê³¼
```typescript
interface FileWriteToolResult {
  success: boolean;     // ì“°ê¸° ì„±ê³µ ì—¬ë¶€
  bytesWritten: number; // ì“°ì¸ ë°”ì´íŠ¸ ìˆ˜
  path: string;         // íŒŒì¼ ê²½ë¡œ
}
```

### ë„êµ¬ ì‹¤í–‰ ë¡œê¹…

ë³´ì•ˆ ê°ì‚¬ ë° ë””ë²„ê¹…ì„ ìœ„í•´ ëª¨ë“  ë„êµ¬ ì‹¤í–‰ì€ ë¡œê·¸ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤.

#### ë¡œê·¸ í•­ëª©
```typescript
interface ToolExecutionLog {
  timestamp: Date;              // ì‹¤í–‰ ì‹œê°„
  toolName: string;             // ë„êµ¬ ì´ë¦„
  params: Record<string, unknown>;  // ì‹¤í–‰ íŒŒë¼ë¯¸í„°
  result: ToolResult;           // ì‹¤í–‰ ê²°ê³¼
  approvalStatus: 'approved' | 'rejected' | 'auto';  // ìŠ¹ì¸ ìƒíƒœ
  sessionId?: string;           // ì„¸ì…˜ ID
  userId?: string;              // ì‚¬ìš©ì ID
  duration: number;             // ì‹¤í–‰ ì‹œê°„ (ms)
  riskLevel: RiskLevel;         // ìœ„í—˜ë„
}
```

#### ë¡œê·¸ ì €ì¥ ìœ„ì¹˜
- **ê°œë°œ í™˜ê²½**: ì½˜ì†” ì¶œë ¥ + íŒŒì¼ (`~/.doppelgesicht/logs/tools.log`)
- **ìš´ì˜ í™˜ê²½**: Supabase `tool_execution_logs` í…Œì´ë¸”

#### ë¡œê·¸ í™œìš©
- ë³´ì•ˆ ê°ì‚¬: ë¯¼ê°í•œ ì‘ì—… ì¶”ì 
- ë””ë²„ê¹…: ì‹¤í–‰ ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
- ì‚¬ìš© í†µê³„: ë„êµ¬ ì‚¬ìš© íŒ¨í„´ ë¶„ì„

### ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

1. **ëª…ë ¹ì–´ ê²€ì¦**: exec ë„êµ¬ ì‹¤í–‰ ì „ ìœ„í—˜ íŒ¨í„´ ì²´í¬
2. **ë„¤íŠ¸ì›Œí¬ ì œí•œ**: ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼ ì œí•œ (10.0.0.0/8, 172.16.0.0/12 ë“±)
3. **íŒŒì¼ ì‹œìŠ¤í…œ ê²©ë¦¬**: í™ˆ ë””ë ‰í† ë¦¬ ì™¸ ì ‘ê·¼ ì œí•œ
4. **ìŠ¹ì¸ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸**: ìì£¼ ì‚¬ìš©í•˜ëŠ” ì•ˆì „í•œ ëª…ë ¹ì–´ ìë™ ìŠ¹ì¸
5. **ì‹¤í–‰ ë¡œê¹…**: ëª¨ë“  ë„êµ¬ ì‹¤í–‰ ê¸°ë¡ ì €ì¥ (ë³´ì•ˆ ê°ì‚¬ìš©)

### êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] ToolDefinition íƒ€ì… ì •ì˜
- [x] ë„êµ¬ ë ˆì§€ìŠ¤íŠ¸ë¦¬ êµ¬í˜„
- [x] LLM í˜¸ì¶œ ì‹œ tools íŒŒë¼ë¯¸í„° ì „ë‹¬
- [x] tool_calls ì‘ë‹µ íŒŒì‹±
- [x] ë„êµ¬ ì‹¤í–‰ ì—”ì§„ (exec, browser)
- [x] ìŠ¹ì¸ ì‹œìŠ¤í…œ ì—°ë™
- [x] tool_result ë©”ì‹œì§€ êµ¬ì„±
- [x] ë°˜ë³µ í˜¸ì¶œ ë£¨í”„ êµ¬í˜„
- [x] íƒ€ì„ì•„ì›ƒ ë° ì—ëŸ¬ ì²˜ë¦¬
- [x] ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜ ì œí•œ (10íšŒ)
- [x] ì´ ì‹¤í–‰ ì‹œê°„ ì œí•œ (5ë¶„)
- [x] ì¶œë ¥ í¬ê¸° ì œí•œ (1MB) - ëª¨ë“  ë„êµ¬ì— ì ìš©
- [ ] ìœ„í—˜ë„ ê¸°ë°˜ ìŠ¹ì¸ ì‹œìŠ¤í…œ (requestApproval)
- [ ] êµ¬ì¡°í™”ëœ ë„êµ¬ ì‹¤í–‰ ë¡œê¹… (ToolExecutionLog)
- [ ] browser ë„êµ¬ êµ¬í˜„
- [ ] channel_send ë„êµ¬ êµ¬í˜„
- [ ] web_fetch POST/PUT/DELETE ì§€ì›

### ì°¸ê³ : OpenAI/Moonshot Tools API

```typescript
// ìš”ì²­
{
  model: 'moonshot-v1-8k',
  messages: [...],
  tools: [
    {
      type: 'function',
      function: {
        name: 'get_weather',
        description: 'Get weather for a location',
        parameters: { ... }
      }
    }
  ],
  tool_choice: 'auto'  // 'auto' | 'none' | { type: 'function', function: { name: '...' } }
}

// ì‘ë‹µ (tool_calls)
{
  id: 'chatcmpl-...',
  choices: [{
    message: {
      role: 'assistant',
      content: null,
      tool_calls: [{
        id: 'call_...',
        type: 'function',
        function: {
          name: 'get_weather',
          arguments: '{"location": "Seoul"}'
        }
      }]
    }
  }]
}
```
